# Readabilityテスト実装計画 (更新版)

## 目的

新しいReadability実装（src）を使って、test/test-pagesのfixtureでテストを行い、抽出されたHTMLの文字数とテキスト内容の文字数が元の実装と±5%の範囲内であることを検証する。

## テスト実装の概要

```mermaid
flowchart TD
    A[テストファイル作成] --> B[テストケース読み込み関数実装]
    B --> C[HTMLパース・抽出関数実装]
    C --> D[文字数比較関数実装 (HTML & テキスト)]
    D --> E[テストケース実行]
    E --> F[結果レポート]
```

## 詳細計画

1.  **テストファイルの作成**:
    *   `src/test/fixture-comparison.test.ts` を作成する。
    *   テストフレームワークとして `vitest` を使用する。

2.  **テストケース読み込み関数の実装**:
    *   `test/test-pages` ディレクトリから特定のテストケース（最初は001〜010）を読み込む関数を実装する。
    *   各テストケースの `source.html`、`expected.html`、`expected-metadata.json` を読み込む。
    *   既存の `test/utils.js` の関数を参考に実装する。

3.  **HTMLパース・抽出関数の実装**:
    *   `source.html` を新しいReadability実装 (`src/index.ts` の `extract` 関数) でパースし、本文 (`ReadabilityArticle.root`) を抽出する。
    *   抽出した本文をHTML文字列に変換する (`src/format.ts` の `toHTML` 関数を使用)。
    *   `expected.html` を読み込み、比較対象として準備する。

4.  **文字数比較関数の実装**:
    *   抽出されたHTML文字列の文字数を計算する。
    *   `expected.html` の文字数を計算する。
    *   抽出されたHTMLからテキスト内容（HTMLタグを除いた純粋なテキスト）を抽出し、その文字数を計算する (`src/format.ts` の `extractTextContent` 関数を利用)。
    *   `expected.html` からテキスト内容（HTMLタグを除く）を抽出し、その文字数を計算する。
    *   HTML文字数の割合 (`抽出されたHTML文字数 / expected.html文字数`) を計算し、±5% (0.95 〜 1.05) の範囲内か判定する。
    *   テキスト内容の文字数の割合 (`抽出されたテキスト文字数 / expectedテキスト文字数`) を計算し、±5% (0.95 〜 1.05) の範囲内か判定する。

5.  **テストケース実行**:
    *   各テストケースに対してテストを実行する。
    *   HTML文字数とテキスト内容文字数の両方の比較結果（文字数、割合、範囲内か）をレポートする。
    *   両方の比較結果が±5%の範囲内であればテスト成功とする。

6.  **拡張計画**:
    *   最初の10ケースでテストが安定して動作することを確認した後、対象を `test/test-pages` 内の全テストケースに拡張する。

## テキスト内容抽出について

HTMLからテキスト内容を抽出する際には、`src/format.ts` にある `extractTextContent` 関数の利用を検討する。必要に応じて、`expected.html` からテキストを抽出するための同様の関数を実装または利用する。

## 実装上の注意点

*   **ファイルパス**: 相対パスの解決に注意し、`path` モジュールなどを適切に使用する。
*   **エラーハンドリング**: ファイル読み込みエラー、パースエラー、抽出失敗時のエラーハンドリングを実装する。
*   **テスト結果**: 失敗したケースについて、どの比較（HTML文字数 or テキスト文字数）で失敗したか、実際の文字数と期待される文字数、割合などの詳細情報を出力するようにする。
*   **拡張性**: 将来的に全テストケースに容易に拡張できるよう、テストケースの指定方法などを考慮する。